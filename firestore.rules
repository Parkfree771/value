rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // 사용자 프로필
    match /users/{userId} {
      // 로그인한 사용자만 프로필 읽기 가능 (개인정보 보호)
      allow read: if request.auth != null;
      // 본인만 수정 가능
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // 리포트 게시글
    match /posts/{postId} {
      allow read: if true; // 모든 게시글 읽기 가능
      allow create: if request.auth != null; // 로그인 사용자만 작성 가능

      // 작성자는 전체 수정 가능
      // 다른 로그인 사용자는 특정 필드만 업데이트 가능
      allow update: if request.auth != null && (
        request.auth.uid == resource.data.authorId ||
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['views', 'likes', 'likedBy', 'currentPrice', 'returnRate', 'is_closed', 'closed_at', 'closed_return_rate', 'closed_price', 'commentCount'])
      );
      allow delete: if request.auth != null && request.auth.uid == resource.data.authorId;

      // 게시글별 좋아요 정보 (서브컬렉션)
      match /likes/{likeUserId} {
        allow read: if true;
        // 본인의 좋아요만 추가/삭제 가능
        allow create, delete: if request.auth != null && request.auth.uid == likeUserId;
        allow update: if false; // 업데이트 불가
      }

      // 게시글별 댓글 (서브컬렉션)
      match /comments/{commentId} {
        allow read: if true;
        allow create: if request.auth != null;
        allow update, delete: if request.auth != null && request.auth.uid == resource.data.authorId;

        // 댓글별 좋아요 (서브서브컬렉션)
        match /likes/{likeUserId} {
          allow read: if true;
          allow create, delete: if request.auth != null && request.auth.uid == likeUserId;
          allow update: if false;
        }
      }
    }

    // 좋아요 정보 (최상위 컬렉션 - 하위 호환성)
    match /likes/{likeId} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // 댓글 (최상위 컬렉션 - 하위 호환성)
    match /comments/{commentId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.authorId;
    }

    // 시스템 설정 (KIS API 토큰 캐시 등)
    match /settings/{settingId} {
      allow read, write: if request.auth != null;
    }

    // SEC 13F 구루 포트폴리오 (Admin SDK로 쓰기, 공개 읽기)
    match /guru_portfolios/{slug} {
      allow read: if true;
      allow write: if false;
    }

    // 게시글 가격 추적 (Posts - Ticker별 가격 정보)
    match /post_prices/{ticker} {
      allow read: if true;
      allow create: if request.auth != null;
      // 서버에서 Admin SDK로 업데이트하므로 클라이언트에서는 불가
      allow update: if false;
      allow delete: if false;
    }

    // 북마크
    match /bookmarks/{bookmarkId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId;
      allow update: if false;
    }

    // 동의 기록 (법적 증거 보관 - 전자상거래법 5년 보관)
    match /consent_records/{recordId} {
      // 본인의 동의 기록만 읽기 가능
      allow read: if request.auth != null && request.auth.uid == resource.data.uid;
      // 로그인한 사용자가 본인의 동의 기록 생성 가능
      allow create: if request.auth != null && request.auth.uid == request.resource.data.uid;
      // 동의 기록은 수정/삭제 불가 (법적 증거 보존)
      allow update, delete: if false;
    }

    // 탈퇴 회원 기록 (법적 보관 의무)
    match /withdrawn_users/{userId} {
      // 본인의 탈퇴 기록만 생성 가능
      allow create: if request.auth != null && request.auth.uid == userId;
      // 탈퇴 기록은 읽기/수정/삭제 불가 (Admin SDK로만 접근)
      allow read, update, delete: if false;
    }

    // Tickers 컬렉션 (게시물 작성 시 ticker 등록, 가격 업데이트 최적화용)
    match /tickers/{ticker} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if false;
    }
  }
}
